@inherits BaseComponent
@using BlazorApp.Client.Components
@using BlazorApp.Shared.Data
@using BlazorApp.Shared.Language
@using GoogleMapsComponents
@using GoogleMapsComponents.Maps
@using BlazorApp.Client.Services
@using LanguageKeys = BlazorApp.Shared.Language.LanguageKeys
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@inject NetworkService NetworkService

<div class="container-fluid d-flex header justify-content-center w-100">
    <div class="main-row px-main row w-100">
        <div class="map-title px-4 col border-bottom border-2 border-dark  bm-2 bg-white mt-5">
            <DebouncedInput Value="@SearchString"
                            ValueChanged="LocationSearch"
                            DebounceMilliseconds="1000"
                            Placeholder="@LanguageService.GetTranslation(LanguageKeys.CalculatorHeader)" />
            <div class="dropdown">
                <div class="dropdown-menu @(_showLocationsList? "d-block": "d-none")" aria-labelledby="dropdownMenuButton">
                    @foreach (var prediction in Predictions)
                    {
                        @if (prediction.LocationSource == Shared.Classes.LocationSource.Known)
                        {
                            <span role="button" class="dropdown-item" href="#" @onclick="() => OnLocationSelect(prediction)">@prediction.Title - @prediction.Address</span>
                        }
                        @if (prediction.LocationSource == Shared.Classes.LocationSource.Google)
                        {
                            <span role="button" class="dropdown-item" href="#" @onclick="() => OnLocationSelect(prediction)">@prediction.Address</span>
                        }
                    }
                </div>
            </div>
        </div>
        @if (ContainErrors)
        {
            <div class="row my-2">
                @foreach (var error in Errors)
                {
                    <div class="col">
                        <div class="alert alert-danger d-flex justify-content-between" role="alert">
                            @error
                            <div role="button" class="btn btn-close" @onclick="()=> RemoveError(error)"></div>
                        </div>
                    </div>
                }
            </div>
        }

        <div class="calc-container row px-0 pb-5 m-0 mb-5">
            <div class="col-12 col-xl-5 input-container order-1 order-xl-0 pt-3">
                <div class="row pb-4">
                    <div class="col-auto">
                        <button @onclick="async () => await AddNewLocation()" class="btn btn-primary" type="button"
                                id="dropdownMenuButton">
                            @GetTranslation(LanguageKeys.AddNewObject)
                        </button>
                    </div>
                </div>
                @if (CurrentRequest != null)
                {
                    <div class="row mb-2">
                        <div class="col-12 label">
                            <span>@GetTranslation(nameof(CurrentRequest.Title))</span>
                        </div>
                        <div class="col-12">
                            <input class="w-100" type="text" name="@nameof(CurrentRequest.Title)"
                                   @bind-value="CurrentRequest.Title" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-12 label">
                            <span>@GetTranslation(nameof(CurrentRequest.Address))</span>
                        </div>
                        <div class="col-12">
                            <input class="w-100" type="text" name="@nameof(CurrentRequest.Address)"
                                   @bind-value="CurrentRequest.Address" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-12 label">
                            <span>@GetTranslation(nameof(CurrentRequest.RoofArea))</span>
                        </div>
                        <div class="col-12">
                            <input class="w-100" type="text" name="@nameof(CurrentRequest.RoofArea)"
                                   @bind-value="CurrentRequest.RoofArea" />
                        </div>
                    </div>
                    <div class="row mb-2 additional-info">
                        <div class="col-6">
                            <span>@GetTranslation(nameof(CurrentRequest.Coordinates.Latitude))</span>
                            <span>@CurrentRequest.Coordinates.Latitude</span>
                        </div>
                        <div class="col-6">
                            <span>@GetTranslation(nameof(CurrentRequest.Coordinates.Longitude))</span>
                            <span>@CurrentRequest.Coordinates.Longitude</span>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-12 label">
                            <span>@GetTranslation(nameof(CurrentRequest.InvestmentPrice))</span>
                        </div>
                        <div class="col-12">
                            <input class="w-100" type="text" name="@nameof(CurrentRequest.InvestmentPrice)"
                                   @bind-value="CurrentRequest.InvestmentPrice" />
                            <span class="w-100 additional-info">
                                @GetTranslation(LanguageKeys.InvestmentPriceNote)
                            </span>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-12">
                            <div class="row">
                                <div class="col-8 label">
                                    <span>@GetTranslation(nameof(CurrentRequest.EnergyPrice))</span>
                                </div>
                                <div class="col label">
                                    <span>@GetTranslation(nameof(CurrentRequest.CurrencyName))</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-8">
                                    <input class="w-100" type="text" name="@nameof(CurrentRequest.EnergyPrice)"
                                           @bind-value="CurrentRequest.EnergyPrice" />
                                </div>
                                <div class="col">
                                    <input class="w-100" type="text" name="@nameof(CurrentRequest.CurrencyName)"
                                           @bind-value="CurrentRequest.CurrencyName" />
                                </div>
                            </div>
                            <span class="w-100 additional-info">
                                @GetTranslation(LanguageKeys.EnergyPriceNote)
                                @GenerationData.EnergyPrice
                            </span>
                        </div>
                    </div>
                }

                @if (IsValidRequest())
                {
                    <div class="row">
                        <div class="col-12">
                            <button class="btn btn-primary"
                                    @onclick="Calculate">
                                @GetTranslation(LanguageKeys.Calculate)
                            </button>
                        </div>
                    </div>
                }

            </div>
            <div class="col-12 col-xl-7 order-0 order-xl-1 px-0">
                <GoogleMap @ref="@_map1" Id="map1" Options="@_mapOptions"
                           OnAfterInit="@(async () => await OnAfterInitAsync())">
                </GoogleMap>
            </div>
            @if (CurrentResponce != null)
            {
                <div class="col-12 d-flex flex-wrap justify-content-around order-2 p-xl-5 py-3">
                    <div class="result-item rounded-3 p-3 my-1">
                        <div class="pb-2 result-title">
                            @GetTranslation(nameof(CurrentResponce.TotalInvestment))
                        </div>
                        <div class=" align-items-center d-flex result-info">
                            <span class="result-number"> @MakeNumberReadable(CurrentResponce.TotalInvestment)</span>
                            <span class="px-2 result-number-text">@CurrentResponce.CurrencyName</span>
                        </div>

                    </div>
                    <div class="result-item rounded-3 p-3 my-1">
                        <div class="pb-2 result-title">
                            @GetTranslation(nameof(CurrentResponce.AvgGeneration))
                        </div>
                        <div class=" align-items-center d-flex result-info">
                            <span class="result-number"> @CurrentResponce.AvgGeneration</span>
                            <span class="px-2 result-number-text">@GetTranslation(LanguageKeys.PowerName)/@GetTranslation(LanguageKeys.Year)</span>
                        </div>
                        <div>
                        </div>
                    </div>
                    <div class=" result-item rounded-3 p-3 my-1">
                        <div class="pb-2 result-title">
                            @GetTranslation(nameof(CurrentResponce.TotalIncome))
                        </div>
                        <div class=" align-items-center d-flex result-info">
                            <span class="result-number">@MakeNumberReadable(CurrentResponce.TotalIncome)</span>
                            <span class="px-2 result-number-text">@CurrentResponce.CurrencyName</span>
                        </div>

                    </div>
                </div>
                <div class="accordion order-3" id="detailsAccordion">
                    <div class="accordion-item">
                        @if (!_showDetails)
                        {
                            <button role="button" class="btn btn-secondary" @onclick="ToggleDetails">
                                @GetTranslation(LanguageKeys.ShowDetailsAboutCalculations)
                            </button>
                        }
                        else
                        {
                            <button role="button" class="btn btn-secondary" @onclick="ToggleDetails">
                                @GetTranslation(LanguageKeys.HideDetailsAboutCalculations)
                            </button>
                        }
                        <div id="detailsInformation" class="mt-4 detailsInfoAccordion accordion-collapse collapse @(_showDetails? "show": "")" data-bs-parent="#accordionExample">
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <td colspan="2"><strong>@CurrentResponce.Title</strong></td>
                                    </tr>
                                    <tr>
                                        <td colspan="2">@CurrentResponce.Address</td>
                                    </tr>
                                    <tr>
                                        <td class="nowrap">@GetTranslation(nameof(CurrentResponce.TotalInvestment))</td>
                                        <td>
                                            <span class="table-number">@MakeNumberReadable(CurrentResponce.TotalInvestment)</span>
                                            <span class="table-currency">@CurrentResponce.CurrencyName</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="nowrap">@GetTranslation(nameof(CurrentResponce.AvgGeneration))</td>
                                        <td>
                                            <span class="table-number">@CurrentResponce.AvgGeneration</span>
                                            <span class="table-currency"> @GetTranslation(LanguageKeys.PowerName)/@GetTranslation(LanguageKeys.Year)</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="nowrap">@GetTranslation(nameof(CurrentResponce.TotalIncome))</td>
                                        <td>
                                            <span class="table-number">@MakeNumberReadable(CurrentResponce.TotalIncome)</span>
                                            <span class="table-currency"> @CurrentResponce.CurrencyName</span>
                                        </td>

                                    </tr>
                                    <tr>
                                        <td class="nowrap">@GetTranslation(nameof(CurrentResponce.Coordinates))</td>
                                        <td>@CurrentResponce.Coordinates.Latitude, @CurrentResponce.Coordinates.Longitude</td>
                                    </tr>
                                    <tr>
                                        <td class="nowrap">@GetTranslation(nameof(CurrentResponce.RoofArea))</td>
                                        <td>
                                            <span class="table-number">@CurrentResponce.RoofArea</span>
                                            <span class="table-currency"> </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="nowrap">@GetTranslation(nameof(CurrentResponce.EffectiveRoofArea))</td>
                                        <td>
                                            <span class="table-number">@CurrentResponce.EffectiveRoofArea</span>
                                            <span class="table-currency"> </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="nowrap">@GetTranslation(nameof(CurrentResponce.EnergyPrice))</td>
                                        <td>
                                            <span class="table-number"></span>
                                            <span class="table-currency">@(CurrentResponce.CurrencyName)/@GetTranslation(LanguageKeys.PowerName)*@GetTranslation(LanguageKeys.Hour)</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="nowrap">@GetTranslation(nameof(CurrentResponce.MinGenetation))</td>
                                        <td>
                                            <span class="table-number">@CurrentResponce.MinGenetation</span>
                                            <span class="table-currency"> @GetTranslation(LanguageKeys.PowerName)/@GetTranslation(LanguageKeys.Month)</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="nowrap">@GetTranslation(nameof(CurrentResponce.MaxGeneration))</td>
                                        <td>
                                            <span class="table-number">@CurrentResponce.MaxGeneration</span>
                                            <span class="table-currency"> @GetTranslation(LanguageKeys.PowerName)/@GetTranslation(LanguageKeys.Month)</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>